import type { OmadaApiResponse, PaginatedResult, GetThreatListOptions, ThreatInfo } from '../types/index.js';
import type { RequestHandler } from './request.js';

/**
 * Security-related operations for the Omada API.
 * Handles threat management and security features.
 */
export class SecurityOperations {
    constructor(
        private readonly request: RequestHandler,
        private readonly buildPath: (path: string) => string
    ) {}

    /**
     * Get the global view threat management list.
     * operationId: getGlobalThreatList
     *
     * @param options - Threat list query options
     * @returns Paginated list of threat information
     */
    async getThreatList(options: GetThreatListOptions): Promise<PaginatedResult<ThreatInfo>> {
        const params: Record<string, unknown> = {
            archived: options.archived,
            page: options.page,
            pageSize: options.pageSize,
            'filters.startTime': options.startTime,
            'filters.endTime': options.endTime,
        };

        if (options.siteList) {
            params.siteList = options.siteList;
        }

        if (options.severity !== undefined) {
            params['filters.severity'] = options.severity;
        }

        if (options.sortTime) {
            params['sorts.time'] = options.sortTime;
        }

        if (options.searchKey) {
            params.searchKey = options.searchKey;
        }

        const path = this.buildPath('/security/threat-management');

        const response = await this.request.get<OmadaApiResponse<PaginatedResult<ThreatInfo>>>(path, params);
        return this.request.ensureSuccess(response);
    }
}
